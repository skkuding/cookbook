+++
title = "7. Prisma"
description = "ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‰½ê²Œ ì“°ë„ë¡ ë„ì™€ì£¼ëŠ” ORMì¸ Prismaì— ëŒ€í•´ ì•Œì•„ë´…ë‹ˆë‹¤."
icon = "article"
date = "2023-09-08"
lastmod = "2023-09-08"
weight = 170
+++

ì´ë²ˆ ì‹œê°„ì—ëŠ” Node.js & TypeScriptì˜ ORM ì¤‘ í•˜ë‚˜ì¸ Prismaì— ëŒ€í•´ ì•Œì•„ë´…ì‹œë‹¤.

## ê³µë¶€í•  ë‚´ìš© ğŸ“š

### 1. Prismaê°€ ë¬´ì—‡ì¸ê°€ìš”?

ORM...?? ORMì€ ë­ê³ , PrismaëŠ” ë˜ ë¬´ì—‡ì¼ê¹Œìš”?

ORMì˜ ì˜ë¯¸ì™€, Prismaê°€ ì–´ë–¤ ì„œë¹„ìŠ¤ì¸ì§€ í•œ ë²ˆ ì•Œì•„ë´…ì‹œë‹¤!

- [ORMì´ ë­˜ê¹Œ?](https://velog.io/@gndan4/ORMì´ë€): ORMì´ ë­”ì§€ ê°„ë‹¨íˆ ì•Œì•„ë´…ì‹œë‹¤!
    - ì´ì™¸ì—ë„ êµ¬ê¸€ë§í•˜ë©´ ORMì— ëŒ€í•´ì„œ ë§ì€ ì •ë³´ë“¤ì´ ë‚˜ì˜¤ë‹ˆ ì°¸ê³ í•´ì£¼ì„¸ìš”! ğŸ˜€
- [Is Prisma an ORM?](https://www.prisma.io/docs/orm/overview/prisma-in-your-stack/is-prisma-an-orm): Prisma ê³µì‹ë¬¸ì„œì—ì„œ Prismaê°€ ë¬´ì—‡ì¸ì§€, ì–´ë–¤ ì›ë¦¬ë¡œ ì‘ë™ë˜ëŠ”ì§€ì— ëŒ€í•´ì„œ ê°„ë‹¨íˆ ì†Œê°œí•´ì¤ë‹ˆë‹¤.
    - [Prismaë€?](https://velog.io/@hwisaac/Prisma-%EB%9E%80): í•œê¸€ë¡œë„ ì§§ê²Œ ì •ë¦¬í•œ ë¸”ë¡œê·¸ ê¸€ë„ ê°€ì ¸ì™€ë´¤ìŠµë‹ˆë‹¤!

### 2. Prisma

ì´ì œ ORMì´ ë¬´ì—‡ì´ê³ , PrismaëŠ” ì–´ë–¤ ì„œë¹„ìŠ¤ì¸ì§€ ì•Œì•„ë³´ì•˜ìœ¼ë‹ˆ êµ¬ì²´ì ìœ¼ë¡œ ì–´ë–»ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ”ì§€ ì•Œì•„ë³¼ê¹Œìš”?

- [What is Prisma?](https://www.prisma.io/docs/orm/overview/introduction/what-is-prisma): Prismaì˜ ì‘ë™ ì›ë¦¬ì— ëŒ€í•´ì„œ ì•Œì•„ë´…ë‹ˆë‹¤. ê¼­ ì½ì–´ë´ì£¼ì„¸ìš”!! â­ï¸
- [Prisma schema](https://www.prisma.io/docs/orm/prisma-schema/overview): PrismaëŠ” schema íŒŒì¼ì„ í†µí•´ ë‹¤ì–‘í•œ ì„¤ì • ì •ë³´ë¥¼ ì–»ê³  ì–´ë– í•œ ë°ì´í„° ëª¨ë¸ì„ ìƒì„±í• ì§€ íŒŒì•…í•©ë‹ˆë‹¤. schema íŒŒì¼ì´ ì–´ë–»ê²Œ êµ¬ì„±ë˜ì–´ ìˆê³ , ë°ì´í„° ëª¨ë¸ì€ ì–´ë–»ê²Œ ì‘ì„±í•  ìˆ˜ ìˆëŠ”ì§€ ì‚´í´ë´ì•¼ê² ì£ ? ğŸ˜†
- [Prisma CRUD](https://www.prisma.io/docs/orm/prisma-client/queries/crud): Prismaì—ì„œëŠ” ì•„ì£¼ ë§ì€.... ê¸°ëŠ¥ë“¤ì´ ìˆëŠ”ë°ìš”, ì´ë²ˆì—ëŠ” ê·¸ì¤‘ ì‹¤ìŠµë•Œ ì“°ì´ëŠ” CRUDê´€ë ¨ ê¸°ëŠ¥ë§Œ ì‚´í´ë´ì£¼ì„¸ìš” ğŸ™‚
-  [Prisma Playground](https://playground.prisma.io): Prismaì—ì„œëŠ” Playgroundë¥¼ í†µí•´ ì›¹ì—ì„œë„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆë„ë¡ í•´ì¤˜ìš”! Playgroundë¥¼ í†µí•´ í•œ ë²ˆ í…ŒìŠ¤íŠ¸í•´ë´ë„ ì¢‹ì•„ìš”!
    - [Prisma Client API reference](https://www.prisma.io/docs/orm/reference/prisma-client-reference): API referenceì¸ë°, ê¶ê¸ˆí•˜ì‹  ë¶€ë¶„ìˆìœ¼ë©´ ì°¾ì•„ë´ë„ ê´œì°®ì„ ê²ƒ ê°™ì•„ìš”!

## í”„ë¡œì íŠ¸ ì‹¤ìŠµ ğŸˆ

ì´ë²ˆ ì£¼ì°¨ëŠ” ì €ë²ˆ ì£¼ì°¨ì—ì„œ ë§Œë“¤ì—ˆë˜ Nest.js ì›¹ì„œë²„ì—ì„œ ì‹¤ì œ ë°ì´í„°ë² ì´ìŠ¤(PostgreSQL)ì— prismaë¥¼ ì´ìš©í•˜ì—¬ CRUD ì½”ë“œë¥¼ ì‘ì„±í•´ë³´ëŠ” ê³¼ì œì…ë‹ˆë‹¤.

> í™˜ê²½ ì„¤ì • ê´€ë ¨í•´ì„œ ì•„ë˜ ì§€ì‹œì‚¬í•­ì„ ë”°ë¼í•´ì£¼ì„¸ìš”!
> ë¬¼ë¡  ê¼­ ê·¸ëŒ€ë¡œ ë”°ë¼í•˜ì‹¤ í•„ìš”ëŠ” ì—†ê³  ìì‹ ì˜ ë°ì´í„° êµ¬ì¡°ì— ë”°ë¼ ë°”ê¾¸ì…”ë„ ê´œì°®ìŠµë‹ˆë‹¤!

### ì‹¤ìŠµ ì„¸ë¶€ ì„¤ëª… âš™ï¸

í™˜ê²½ì„¸íŒ…ê³¼ ê´€ë ¨í•´ì„œ ë„ì™€ë“œë¦´ê²Œìš”!
ë°‘ì˜ ì ˆì°¨ë¥¼ ë”°ë¼ì™€ì£¼ì„¸ìš”

> ì°¸ê³  : https://www.prisma.io/blog/nestjs-prisma-rest-api-7D056s1BmOL0

ì‹œì‘ ì „, [Docker ì„¤ì¹˜ ê°€ì´ë“œ](../infra/Install%20Docker.md)ë¥¼ ì°¸ê³ í•˜ì—¬ Dockerë¥¼ ì„¤ì¹˜í•´ì£¼ì„¸ìš”!

Root ë””ë ‰í† ë¦¬ì— `docker-compose.yml`ë¥¼ ìƒì„±í•˜ê³ , ì•„ë˜ íŒŒì¼ì„ ë³µì‚¬-ë¶™ì—¬ë„£ê¸° í•´ì£¼ì„¸ìš”.
```docker
# docker-compose.yml

version: '3.8'
services:
  postgres:
    image: postgres:13.5
    restart: always
    environment:
      - POSTGRES_USER=myuser
      - POSTGRES_PASSWORD=mypassword
    volumes:
      - postgres:/var/lib/postgresql/data
    ports:
      - '5432:5432'

volumes:
  postgres:
```
ê·¸ ë’¤, í„°ë¯¸ë„ì—ì„œ `docker-compose up -d` ì„ ì‹¤í–‰í•˜ê³ (`-d`ëŠ” ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰í•˜ëŠ” ì˜µì…˜) , ì •ìƒì ìœ¼ë¡œ ì»¨í…Œì´ë„ˆê°€ ìƒì„±ë˜ê³  ì‹¤í–‰ë˜ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš” 

- í„°ë¯¸ë„ì— Running í‘œì‹œ í˜¹ì€ docker gui ì—ì„œ ì‹¤í–‰ë˜ê³  ìˆë‹¤ë©´ ì„±ê³µì…ë‹ˆë‹¤
- **ğŸ› ï¸ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•´ì•¼ì§€ ë°‘ì˜ ê³¼ì •ì—ì„œ ì˜¤ë¥˜ê°€ ìƒê¸°ì§€ ì•ŠìŠµë‹ˆë‹¤!**


ë‹¤ìŒìœ¼ë¡œ í„°ë¯¸ë„ì— `npm install -D prisma` ì„ ì…ë ¥í•´ prisma ë¥¼ ì„¤ì¹˜í•´ì¤ë‹ˆë‹¤.

ë£¨íŠ¸ ë””ë ‰í† ë¦¬ì—ì„œ `npx prisma init` ë¥¼ ì…ë ¥í•˜ë©´, prisma í´ë”ì™€ Schema íŒŒì¼ì´ ìƒì„±ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

- ë£¨íŠ¸ í´ë”ì— ***.env*** íŒŒì¼ì´ ìƒì„±ë˜ì—ˆëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆëŠ”ë°ìš”, ì•ˆì—ëŠ” database_url ì´ ë“¤ì–´ìˆì„ ê±´ë° ë°‘ê³¼ ê°™ì´ ë³€ê²½í•´ì¤ë‹ˆë‹¤.

    ```docker
    // .env
    DATABASE_URL="postgres://myuser:mypassword@localhost:5432/median-db"
    ```

`prisma/schema.prisma` ì— ë“¤ì–´ê°€ ë§¨ ë°‘ì— restaurant model ì„ ì¶”ê°€í•´ì¤ì‹œë‹¤! 
- ìì‹ ì˜ ë°ì´í„°êµ¬ì¡°ì— ë§ê²Œ ììœ ë¡­ê²Œ ì‘ì„±í•´ì£¼ì‹œë©´ ë©ë‹ˆë‹¤! ì œê°€ ì‘ì„±í•œ ì˜ˆì‹œë¥¼ ë‚¨ê²¨ë“œë¦½ë‹ˆë‹¤.

    ```docker
    // This is your Prisma schema file,
    // learn more about it in the docs: https://pris.ly/d/prisma-schema

    generator client {
    provider = "prisma-client-js"
    }

    datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
    }

    model Restaurant {
    id          Int      @id @default(autoincrement())
    name       String   @unique
    address String
    phone        String
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt
    }
    ```

ë‹¤ìŒ, ìš°ë¦¬ê°€ ìƒì„±í•œ ë°ì´í„° ëª¨ë¸ì„ migrateí•˜ê¸° ìœ„í•´ ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•´ì¤ë‹ˆë‹¤.
```shell
npx prisma migrate dev --name "init"
```
- ì„±ê³µì ìœ¼ë¡œ ë˜ì—ˆë‹¤ë©´ terminalì— `Your database is now in sync with your schema`ë¼ëŠ” ë¬¸ì¥ê³¼ í•¨ê»˜ `prisma` ì•ˆì— `migration` í´ë”ê°€ ìƒì„±ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì–´ìš©

ì›í™œí•œ í…ŒìŠ¤íŒ…ì„ ìœ„í•´ ë°ì´í„°ë² ì´ìŠ¤ì— ë¯¸ë¦¬ seed ë°ì´í„°ë„ ì‹¬ì–´ë†“ìì‹œë‹¤.
- ì•„ë˜ `seed.ts`ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”! (ë°ì´í„° êµ¬ì¡°ëŠ” ìì‹ ì˜ ê²ƒê³¼ ì¼ì¹˜í•˜ê²Œ ìˆ˜ì •í•´ì£¼ì…”ë„ ë©ë‹ˆë‹¹)
```jsx
// prisma/seed.ts

import { PrismaClient } from '@prisma/client';

// initialize Prisma Client
const prisma = new PrismaClient();

async function main() {
  // create two dummy articles
  const restaurant1 = await prisma.restaurant.upsert({
    where: { name: 'ë´‰ìˆ˜ìœ¡' },
    update: {},
    create: {
      name: 'ë´‰ìˆ˜ìœ¡',
      address: 'ê²½ê¸° ìˆ˜ì›ì‹œ ì¥ì•ˆêµ¬ ìœ¨ì „ë¡œ108ë²ˆê¸¸ 11 1ì¸µ',
      phone: '0507-1460-0903',
    },
  });

  const restaurant2 = await prisma.restaurant.upsert({
    where: { name: 'ì²­ë…„ë°¥ìƒ' },
    update: {},
    create: {
      name: 'ì²­ë…„ë°¥ìƒ',
      address: 'ê²½ê¸° ìˆ˜ì›ì‹œ ì¥ì•ˆêµ¬ ì„œë¶€ë¡œ2136ë²ˆê¸¸ 10 1ì¸µ',
      phone: '0507-1307-1822',
    },
  });

  console.log({ restaurant1, restaurant2 });
}

// execute the main function
main()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    // close Prisma Client at the end
    await prisma.$disconnect();
  });
```

ê·¸ë¦¬ê³  `package.json`ì— ì•„ë˜ ëª…ë ¹ì–´ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.
```jsx
// package.json

// ...
  "scripts": {
    // ...
  },
  "dependencies": {
    // ...
  },
  "devDependencies": {
    // ...
  },
  "jest": {
    // ...
  },
  **"prisma": {
    "seed": "ts-node prisma/seed.ts"
  }**
```
ê·¸ë¦¬ê³  í„°ë¯¸ë„ì— `npx prisma db seed`ë¥¼ ì…ë ¥í•´ì£¼ì‹œë©´ ê·€ì—¬ìš´ ìƒˆì‹¹ëª¨ì–‘ ì•„ì´ì½˜ì´ ëœ°ê±°ì—ìš”ã….ã…

prismaë¥¼ ì—°ê²°í•´ì£¼ê¸° ìœ„í•´

```shell
npx nest generate module prisma
npx nest generate service prisma
```

ë¥¼ ì…ë ¥í•´ì£¼ì‹œê³ ,  `prisma.service.ts` íŒŒì¼ì„ ì¡°ê¸ˆ ìˆ˜ì •í•´ì¤ë‹ˆë‹¤.

```jsx
// src/prisma/prisma.service.ts

import { INestApplication, Injectable } from '@nestjs/common';
import { PrismaClient } from '@prisma/client';

@Injectable()
export class PrismaService extends PrismaClient {
  async enableShutdownHooks(app: INestApplication) {
    this.$on('beforeExit', async () => {
      await app.close();
    });
  }
}
```

ê·¸ë¦¬ê³  `prisma.module.ts` ë„ ìˆ˜ì •í•´ì¤ë‹ˆë‹¤. (exportsì— ì¶”ê°€)

```jsx
// src/prisma/prisma.module.ts

import { Module } from '@nestjs/common';
import { PrismaService } from './prisma.service';

@Module({
  providers: [PrismaService],
  exports: [PrismaService],
})
export class PrismaModule {}
```

ë§ˆì§€ë§‰ìœ¼ë¡œ ì €í¬ Restaurant ëª¨ë“ˆì—ì„œ ì“°ê¸° ìœ„í•˜ì—¬ service, module íŒŒì¼ì„ ì¡°ê¸ˆ ìˆ˜ì •í•´ì£¼ì„¸ìš”!
- ë°‘ì—ëŠ” ì˜ˆì‹œ ì½”ë“œì…ë‹ˆë‹¤.
```jsx
//restaurant.module.ts
import { Module } from '@nestjs/common';
import { PrismaModule } from 'src/prisma/prisma.module';
import { RestaurantController } from './restaurant.controller';
import { RestaurantService } from './restaurant.service';

@Module({
  controllers: [RestaurantController],
  providers: [RestaurantService],
  imports: [PrismaModule],
})
export class RestaurantModule {}
```

```jsx
//restaurant.service.ts
import { Injectable } from '@nestjs/common';
import { PrismaService } from 'src/prisma/prisma.service';

@Injectable()
export class RestaurantService {
  constructor(private prisma: PrismaService) {}
	
	//example
  async getAllRestaurants() {
    return await this.prisma.restaurant.findMany({
      select: {
        name: true,
        address: true,
        phone: true,
      },
    });
  }
}
```

ì´ì œ ì§ì ‘ CRUD ì½”ë“œë¥¼ ì‘ì„±í•˜ë©´ ë©ë‹ˆë‹¤. ğŸ˜†
- ì°¸ê³ ë¡œ, `npx prisma studio` ë¥¼ ì…ë ¥í•˜ë©´ 5555í¬íŠ¸ì—ì„œ ì •ë§ ê°„í¸í•˜ê²Œ db ë¥¼ ëˆˆìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆìœ¼ë‹ˆ ì• ìš©í•´ì£¼ì„¸ìš” ğŸ˜»
